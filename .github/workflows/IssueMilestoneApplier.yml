name: Sync milestone to sub-issues

on:
  issues:
    types: [milestoned, demilestoned]

permissions:
  issues: write

jobs:
  sync-milestone:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const event = context.payload.action; // "milestoned" or "demilestoned"

            // Determine target milestone
            const milestoneNumber =
              event === "milestoned"
                ? issue.milestone?.number
                : null;

            // GraphQL query to fetch sub-issues
            const query = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    subIssues(first: 20) {
                      nodes {
                        number
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: issue.number,
            });

            const subIssues =
              result.repository.issue.subIssues.nodes;

            if (!subIssues || subIssues.length === 0) {
              console.log("No sub-issues found.");
              return;
            }

            console.log(
              `${event}: syncing milestone for ${subIssues.length} sub-issues`
            );

            for (const sub of subIssues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: sub.number,
                milestone: milestoneNumber,
              });

              console.log(
                `Updated sub-issue #${sub.number} â†’ ${
                  milestoneNumber ?? "none"
                }`
              );
            }
